!function(e){"use strict";e.module("alt.koopon.selecao-empresa",["ngResource","alt.passaporte-usuario-logado","alt.alerta-flutuante","alt.modal-service","alt.passaporte-procuracao","alt.alerta-flutuante","alt.carregando-info"]).config(["$httpProvider",function(e){e.interceptors.push("AltKooponEmpresaNaoSelecionadaInterceptor")}]).constant("ID_STATUS_BIMER_PLENO_ATENDIMENTO","0010000001").constant("ID_MODAL_EMPRESA_SEM_PERMISSAO_ACESSO","#alt-koopon-selecao-empresa-modal-inadimplencia").constant("AltKooponEventoEmpresa",{EVENTO_EMPRESA_ESCOLHIDA:"alt.koopon.empresa-escolhida",EVENTO_EMPRESA_NAO_CONFIGURADA:"alt.koopon.empresa-nao-configurada"}).provider("AltKooponSelecaoEmpresaPassaporteUrlBase",[function(){this.url="",this.$get=[function(){return this.url}]}]).provider("AltKooponSelecaoEmpresaChaveProduto",[function(){this.chave="",this.$get=[function(){return this.chave}]}]).factory("AltKooponEmpresaNaoSelecionadaInterceptor",["$rootScope","$q","$location","AltKooponEventoEmpresa",function(e,o,r,t){return{responseError:function(a){var n=!!a&&403===a.status&&!!a.data&&a.data.deveSelecionarEmpresa,s=!!~r.path().indexOf("wizard");return n&&!s&&(e.$broadcast(t.EVENTO_EMPRESA_NAO_CONFIGURADA),r.path("/selecao-empresas")),o.reject(a)}}}]).provider("AltKoopon_BASE_API",function(){this.url="/koopon-rest-api/",this.$get=function(){return this.url}}).factory("AltKooponEmpresaResource",["$resource","AltKoopon_BASE_API",function(e,o){var r=o+"assinantes/selecao",t={},a={escolhe:{method:"POST",isArray:!1}};return e(r,t,a)}]).factory("AltPassaportePublicoResource",["$resource","AltKooponSelecaoEmpresaPassaporteUrlBase","AltKooponSelecaoEmpresaChaveProduto",function(e,o,r){var t=o+"assinantes/:idExterno/produtos/"+r,a={},n={dadosAssinanteProduto:{method:"GET"}};return e(t,a,n)}]).factory("AltKooponPermissaoAssinanteService",["$http","$location","$log","AltPassaportePublicoResource","ID_STATUS_BIMER_PLENO_ATENDIMENTO",function(e,o,r,t,a){var n=function(e){return t.query({idExterno:e}).$promise.then(function(e){return e[0]})["catch"](function(){return r.error("Falha ao obter dados administrativos do assinante "+e+" para o produto."),null})},s=function(e){return n(e).then(function(e){return!!e&&(e.idStatusCrm==a&&!e.inadimplenteCrm)})};return{temPermissaoAcesso:s}}]).factory("AltKooponEmpresaService",["$rootScope","$q","$xtorage","AltPassaporteUsuarioLogadoManager","AltKooponEmpresaResource","AltKooponEventoEmpresa",function(e,o,r,t,a,n){var s="emp_escolhida",c=function(){};return c.prototype.getEmpresas=function(e){var o=e||"assinantes";return t.retorna()[o]},c.prototype.salvaNaStorageEmpresaEscolhida=function(e,o){var t=o||s;r.save(t,e)},c.prototype.getEmpresaEscolhidaDaStorage=function(e){var o=e||s;return r.get(o)},c.prototype.escolhe=function(r){return angular.isUndefined(r)||!angular.isObject(r)||angular.isUndefined(r.id)?o.reject(new TypeError("Empresa deve ser informada para ser passada ao servidor.")):a.escolhe({empresaEscolhida:r.id}).$promise.then(function(o){return e.$broadcast(n.EVENTO_EMPRESA_ESCOLHIDA,r),o})["catch"](function(e){return o.reject(e)})},new c}]).service("AltKooponSelecaoEmpresasHelper",["$location","AltKooponEmpresaService",function(e,o){this.escolheEmpresaSemProcuracao=function(r){return o.escolhe(r).then(function(){o.salvaNaStorageEmpresaEscolhida(r),e.path("/")})}}]).controller("AltKooponSelecaoEmpresasController",["AltKooponSelecaoEmpresasHelper","AltKooponPermissaoAssinanteService","AltKooponEmpresaService","AltAlertaFlutuanteService","AltCarregandoInfoService","AltModalService","ID_MODAL_EMPRESA_SEM_PERMISSAO_ACESSO",function(e,o,r,t,a,n,s){var c=this;c.empresas=[],c.escolheEmpresa=function(r){a.exibe(),o.temPermissaoAcesso(r.idExterno).then(function(o){return o?e.escolheEmpresaSemProcuracao(r)["catch"](function(e){t.exibe({msg:e.mensagem})})["finally"](function(){a.esconde()}):(a.esconde(),void n.open(s,{backdrop:"static"}))})},c.init=function(e){c.empresas=r.getEmpresas(e)||c.empresas,1===c.empresas.length&&c.escolheEmpresa(c.empresas[0])}}]).controller("AltEmpresaEscolhidaController",["$rootScope","$scope","AltKooponEmpresaService",function(e,o,r){var t=this;t.empresaEscolhida=r.getEmpresaEscolhidaDaStorage(),o.$on("$destroy",function(){t.empresaEscolhida=null})}])}(window.angular);