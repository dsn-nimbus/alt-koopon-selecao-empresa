!function(e){"use strict";e.module("alt.koopon.selecao-empresa",["ngResource","alt.passaporte-usuario-logado","alt.alerta-flutuante","alt.modal-service","alt.passaporte-procuracao","alt.alerta-flutuante","alt.carregando-info"]).config(["$httpProvider",function(e){e.interceptors.push("AltKooponEmpresaNaoSelecionadaInterceptor")}]).constant("ID_KOOPON_EMPRESA","60f1fe1f835b14a3d20ac0f046fac668").constant("ID_KOOPON_CONTADOR","3c59dc048e8850243be8079a5c74d079").constant("PASSAPORTE_PUBLICO_BASE_URI","https://passaporte2.alterdata.com.br/passaporte-rest-api/rest/publico/").constant("PASSAPORTE_PUBLICO_BASE_URI_DEV","https://passaporte2-dev.alterdata.com.br/passaporte-rest-api/rest/publico/").constant("PASSAPORTE_PUBLICO_BASE_URI_HML","https://passaporte2-hml.alterdata.com.br/passaporte-rest-api/rest/publico/").constant("CHAVE_PRODUTO_KOOPON","690bbae547bc55fbe4d2aaea8f9b733a").constant("ID_STATUS_BIMER_PLENO_ATENDIMENTO","0010000001").constant("AltKooponEventoEmpresa",{EVENTO_EMPRESA_ESCOLHIDA:"alt.koopon.empresa-escolhida",EVENTO_EMPRESA_NAO_CONFIGURADA:"alt.koopon.empresa-nao-configurada"}).factory("AltKooponEmpresaNaoSelecionadaInterceptor",["$rootScope","$q","$location","AltKooponEventoEmpresa",function(e,o,a,t){return{responseError:function(r){var n=!!r&&403===r.status&&!!r.data&&r.data.deveSelecionarEmpresa,s=!!~a.path().indexOf("wizard");return n&&!s&&(e.$broadcast(t.EVENTO_EMPRESA_NAO_CONFIGURADA),a.path("/selecao-empresas")),o.reject(r)}}}]).provider("AltKoopon_BASE_API",function(){this.url="/koopon-rest-api/",this.$get=function(){return this.url}}).factory("AltKooponEmpresaResource",["$resource","AltKoopon_BASE_API",function(e,o){var a=o+"assinantes/selecao",t={},r={escolhe:{method:"POST",isArray:!1}};return e(a,t,r)}]).factory("AltPassaportePublicoResource",["$resource","$location","PASSAPORTE_PUBLICO_BASE_URI","PASSAPORTE_PUBLICO_BASE_URI_DEV","PASSAPORTE_PUBLICO_BASE_URI_HML",function(e,o,a,t,r){var n=/.+(-dev).+/.test(o.host()),s=/.+(-hml).+/.test(o.host()),c=n?t:s?r:a,i=c+"assinantes/:idExterno/produtos/:chaveProduto",p={},l={dadosAssinanteProduto:{method:"GET"}};return e(i,p,l)}]).factory("AltKooponPermissaoAssinanteService",["$http","$location","$log","AltPassaportePublicoResource","CHAVE_PRODUTO_KOOPON","ID_STATUS_BIMER_PLENO_ATENDIMENTO",function(e,o,a,t,r,n){var s=function(e){return t.query({idExterno:e,chaveProduto:r}).$promise.then(function(e){return e[0]})["catch"](function(){return a.error("Falha ao obter dados administrativos do assinante "+e+" para o produto."),null})},c=function(e){return s(e).then(function(e){return!!e&&(e.idStatusCrm==n&&!e.inadimplenteCrm)})};return{temPermissaoAcesso:c}}]).factory("AltKooponEmpresaService",["$rootScope","$q","$xtorage","AltPassaporteUsuarioLogadoManager","AltKooponEmpresaResource","AltKooponEventoEmpresa",function(e,o,a,t,r,n){var s="emp_escolhida",c=function(){};return c.prototype.getEmpresas=function(e){var o=e||"assinantes";return t.retorna()[o]},c.prototype.salvaNaStorageEmpresaEscolhida=function(e,o){var t=o||s;a.save(t,e)},c.prototype.getEmpresaEscolhidaDaStorage=function(e){var o=e||s;return a.get(o)},c.prototype.escolhe=function(a){return angular.isUndefined(a)||!angular.isObject(a)||angular.isUndefined(a.id)?o.reject(new TypeError("Empresa deve ser informada para ser passada ao servidor.")):r.escolhe({empresaEscolhida:a.id}).$promise.then(function(o){return e.$broadcast(n.EVENTO_EMPRESA_ESCOLHIDA,a),o})["catch"](function(e){return o.reject(e)})},new c}]).service("AltKooponSelecaoEmpresasHelper",["$location","AltKooponEmpresaService",function(e,o){this.escolheEmpresaSemProcuracao=function(a){return o.escolhe(a).then(function(){o.salvaNaStorageEmpresaEscolhida(a),e.path("/")})}}]).controller("AltKooponSelecaoEmpresasController",["AltKooponSelecaoEmpresasHelper","AltKooponPermissaoAssinanteService","AltKooponEmpresaService","AltAlertaFlutuanteService","AltCarregandoInfoService","AltModalService",function(e,o,a,t,r,n){var s=this,c="#koopon-core-modal-empresa-pendencias-administrativas";s.empresas=[],s.escolheEmpresa=function(a){r.exibe(),o.temPermissaoAcesso(a.idExterno).then(function(o){return o?e.escolheEmpresaSemProcuracao(a)["catch"](function(e){t.exibe({msg:e.mensagem})})["finally"](function(){r.esconde()}):(r.esconde(),void n.open(c,{backdrop:"static"}))})},s.init=function(e){s.empresas=a.getEmpresas(e)||s.empresas,1===s.empresas.length&&s.escolheEmpresa(s.empresas[0])}}]).controller("AltEmpresaEscolhidaController",["$rootScope","$scope","AltKooponEmpresaService",function(e,o,a){var t=this;t.empresaEscolhida=a.getEmpresaEscolhidaDaStorage(),o.$on("$destroy",function(){t.empresaEscolhida=null})}])}(window.angular);