!function(e){"use strict";e.module("alt.koopon.selecao-empresa",["ngResource","alt.passaporte-usuario-logado","alt.alerta-flutuante","alt.modal-service","alt.passaporte-procuracao","alt.alerta-flutuante","alt.carregando-info"]).config(["$httpProvider",function(e){e.interceptors.push("AltKooponEmpresaNaoSelecionadaInterceptor")}]).constant("ID_STATUS_BIMER_PLENO_ATENDIMENTO","0010000001").constant("ID_STATUS_BIMER_DEMONSTRACAO","0010000005").constant("ID_MODAL_EMPRESA_SEM_PERMISSAO_ACESSO","#alt-koopon-selecao-empresa-modal-inadimplencia").constant("AltKooponEventoEmpresa",{EVENTO_EMPRESA_ESCOLHIDA:"alt.koopon.empresa-escolhida",EVENTO_EMPRESA_NAO_CONFIGURADA:"alt.koopon.empresa-nao-configurada"}).constant("moment",moment).provider("AltKooponSelecaoEmpresaPassaporteUrlBase",[function(){this.url="",this.$get=[function(){return this.url}]}]).provider("AltKooponSelecaoEmpresaChaveProduto",[function(){this.chave="",this.$get=[function(){return this.chave}]}]).factory("AltKooponEmpresaNaoSelecionadaInterceptor",["$rootScope","$q","$location","AltKooponEventoEmpresa",function(e,o,a,t){return{responseError:function(r){var n=!!r&&403===r.status&&!!r.data&&r.data.deveSelecionarEmpresa,s=!!~a.path().indexOf("wizard");return n&&!s&&(e.$broadcast(t.EVENTO_EMPRESA_NAO_CONFIGURADA),a.path("/selecao-empresas")),o.reject(r)}}}]).provider("AltKoopon_BASE_API",function(){this.url="/koopon-rest-api/",this.$get=function(){return this.url}}).factory("AltKooponEmpresaResource",["$resource","AltKoopon_BASE_API",function(e,o){var a=o+"assinantes/selecao",t={},r={escolhe:{method:"POST",isArray:!1}};return e(a,t,r)}]).service("AltKooponBuscaAssinantePassaporteService",["$http","AltKooponSelecaoEmpresaPassaporteUrlBase","AltKooponSelecaoEmpresaChaveProduto","ID_STATUS_BIMER_PLENO_ATENDIMENTO","ID_STATUS_BIMER_DEMONSTRACAO","moment",function(e,o,a,t,r,n){this.temPermissaoAcesso=function(s){return e.get(o+"publico/assinantes/"+s+"/produtos/"+a).then(function(e){if(!e||!e.data||!e.data.length)return!1;var o=e.data[0],a=!1;if(o.inadimplenteCrm)return!1;if(o.idStatusCrm==r){var s=o.dataFinalDemonstracao?n(o.dataFinalDemonstracao,"YYYY-MM-DD"):null;a=!!s&&s.diff(n(),"days")>=0}return o.idStatusCrm==t||a})}}]).factory("AltKooponEmpresaService",["$rootScope","$http","$q","$xtorage","AltPassaporteUsuarioLogadoManager","AltKooponEmpresaResource","AltKooponEventoEmpresa","AltKooponSelecaoEmpresaPassaporteUrlBase","AltKooponSelecaoEmpresaChaveProduto",function(e,o,a,t,r,n,s,i,c){var p="emp_escolhida",l=function(){};return l.prototype.getEmpresas=function(e){var o=e||"assinantes";return r.retorna()[o]},l.prototype.salvaNaStorageEmpresaEscolhida=function(e,o){var a=o||p;t.save(a,e)},l.prototype.getEmpresaEscolhidaDaStorage=function(e){var o=e||p;return t.get(o)},l.prototype.escolhe=function(t){return angular.isUndefined(t)||!angular.isObject(t)||angular.isUndefined(t.id)?a.reject(new TypeError("Empresa deve ser informada para ser passada ao servidor.")):n.escolhe({empresaEscolhida:t.id}).$promise.then(function(){const a=i+"authorization/token",r=i+"authorization/assinantes/"+t.id+"/produtos/"+c;return o.get(a).then(function(a){return o.get(r+"?token="+a.data.token).then(function(o){return e.$broadcast(s.EVENTO_EMPRESA_ESCOLHIDA,o.data.assinantes[0]),o.data.assinantes[0]})})})},new l}]).service("AltKooponSelecaoEmpresasHelper",["$location","AltKooponEmpresaService",function(e,o){this.escolheEmpresaSemProcuracao=function(a){return o.escolhe(a).then(function(a){o.salvaNaStorageEmpresaEscolhida(a),e.path("/")})}}]).controller("AltKooponSelecaoEmpresasController",["AltKooponSelecaoEmpresasHelper","AltKooponBuscaAssinantePassaporteService","AltKooponEmpresaService","AltAlertaFlutuanteService","AltCarregandoInfoService","AltModalService","ID_MODAL_EMPRESA_SEM_PERMISSAO_ACESSO",function(e,o,a,t,r,n,s){var i=this;i.empresas=[],i.escolheEmpresa=function(a){r.exibe(),o.temPermissaoAcesso(a.idExterno).then(function(o){return o?e.escolheEmpresaSemProcuracao(a)["catch"](function(e){t.exibe({msg:e.mensagem})})["finally"](function(){r.esconde()}):(r.esconde(),void n.open(s,{backdrop:"static"}))})},i.init=function(e){i.empresas=a.getEmpresas(e)||i.empresas,1===i.empresas.length&&i.escolheEmpresa(i.empresas[0])}}]).controller("AltEmpresaEscolhidaController",["$rootScope","$scope","AltKooponEmpresaService",function(e,o,a){var t=this;t.empresaEscolhida=a.getEmpresaEscolhidaDaStorage(),o.$on("$destroy",function(){t.empresaEscolhida=null})}])}(window.angular);