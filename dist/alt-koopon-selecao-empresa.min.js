!function(e){"use strict";e.module("alt.koopon.selecao-empresa",["ngResource","alt.passaporte-usuario-logado","alt.alerta-flutuante","alt.passaporte-procuracao","alt.alerta-flutuante","alt.carregando-info"]).config(["$httpProvider",function(e){e.interceptors.push("AltKooponEmpresaNaoSelecionadaInterceptor")}]).constant("_",_).constant("ID_KOOPON_EMPRESA","60f1fe1f835b14a3d20ac0f046fac668").constant("ID_KOOPON_CONTADOR","3c59dc048e8850243be8079a5c74d079").constant("AltKooponEventoEmpresa",{EVENTO_EMPRESA_ESCOLHIDA:"empresa-escolhida",EVENTO_EMPRESA_NAO_CONFIGURADA:"empresa-nao-configurada"}).factory("AltKooponEmpresaNaoSelecionadaInterceptor",["$rootScope","$q","$location","AltKooponEventoEmpresa",function(e,a,o,r){return{responseError:function(t){var n=!!t&&403===t.status&&!!t.data&&t.data.deveSelecionarEmpresa,s=!!~o.path().indexOf("wizard");return e.$broadcast(r.EVENTO_EMPRESA_NAO_CONFIGURADA),n&&!s&&o.path("/selecao-empresas"),a.reject(t)}}}]).provider("AltKoopon_BASE_API",function(){this.url="/koopon-rest-api/",this.$get=function(){return this.url}}).factory("AltKooponEmpresaResource",["$resource","AltKoopon_BASE_API",function(e,a){var o=a+"assinantes/selecao",r={},t={escolhe:{method:"POST",isArray:!1}};return e(o,r,t)}]).factory("AltKooponEmpresaService",["$rootScope","$q","$xtorage","AltPassaporteUsuarioLogadoManager","AltKooponEmpresaResource","AltKooponEventoEmpresa",function(e,a,o,r,t,n){var s="emp_escolhida",c=function(){};return c.prototype.getEmpresas=function(e){var a=e||"assinantes";return r.retorna()[a]},c.prototype.salvaNaStorageEmpresaEscolhida=function(e,a){var r=a||s;o.save(r,e)},c.prototype.getEmpresaEscolhidaDaStorage=function(e){var a=e||s;return o.get(a)},c.prototype.escolhe=function(o){return angular.isUndefined(o)||!angular.isObject(o)||angular.isUndefined(o.id)?a.reject(new TypeError("Empresa deve ser informada para ser passada ao servidor.")):t.escolhe({empresaEscolhida:o.id}).$promise.then(function(a){return e.$broadcast(n.EVENTO_EMPRESA_ESCOLHIDA),a})["catch"](function(e){return a.reject(e)})},new c}]).service("AltKooponSelecaoEmpresasHelper",["$location","AltKooponEmpresaService","AltPassaporteUsuarioLogadoManager","AltPassaporteProcuracaoService","_","ID_KOOPON_EMPRESA","ID_KOOPON_CONTADOR",function(a,o,r,t,n,s,c){this.escolheEmpresaComProcuracao=function(i){return o.escolhe(i).then(function(){return t.getInfo(i.id,c,s).then(function(t){var s=angular.copy(t);s.assinantesEmpresa=t.assinantes||[],s.assinantes.length=0;var c=r.retorna();e.isArray(c.assinantes)&&(c.assinantes.length=0),e.isArray(c.assinantesEmpresa)&&(c.assinantesEmpresa.length=0);var p=n.merge(s,c);r.atualiza(p),o.salvaNaStorageEmpresaEscolhida(i),a.path("/")})})},this.escolheEmpresaSemProcuracao=function(e){return o.escolhe(e).then(function(){a.path("/"),o.salvaNaStorageEmpresaEscolhida(e)})}}]).controller("AltKooponSelecaoEmpresasController",["AltKooponSelecaoEmpresasHelper","AltKooponEmpresaService","AltAlertaFlutuanteService","AltCarregandoInfoService","_",function(e,a,o,r,t){var n=this;n.empresas=[],n._escolheEmpresa=function(a){r.exibe(),e.escolheEmpresaSemProcuracao(a)["catch"](function(e){o.exibe({msg:e.mensagem})})["finally"](function(){r.esconde()})},n._escolheEmpresaComProcuracao=function(a){r.exibe(),e.escolheEmpresaComProcuracao(a)["catch"](function(e){o.exibe({msg:e.mensagem})})["finally"](function(){r.esconde()})},n.escolheEmpresa=function(e,a){a?n._escolheEmpresaComProcuracao(e):n._escolheEmpresa(e)},n.init=function(e,o){n.empresas=a.getEmpresas(e)||n.empresas,1===n.empresas.length&&n._escolheEmpresa(n.empresas[0],o)},n.initComProcuracao=function(e){n.init(e,!0)}}])}(window.angular);
